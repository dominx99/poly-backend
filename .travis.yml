env:
  - DOCKER_COMPOSE_VERSION=3

addons:
  apt:
    packages:
      - docker-ce

group: edge
language: php
php:
  - '7.3'

services:
  - docker

before_install:
  - cp .env.travis .env.testing
  - mkdir .composer
  - chmod -R 777 .composer
  - docker-compose down
  - docker-compose build
  - docker-compose up -d
  - |
    while [ "$(docker inspect -f '{{.State.Health.Status}}' polybackend_db_1)" != "healthy" ];
    do
        sleep 1
    done
  - docker exec -t poly_backend mysql -u root -psecret -h db -e 'CREATE DATABASE IF NOT EXISTS poly_backend_test;'
  - docker exec -t poly_backend composer self-update
  - docker exec -t poly_backend composer update ${COMPOSER_FLAGS} --no-interaction --prefer-dist

script:
  - docker exec -it poly_backend vendor/bin/phpcs --standard=psr2 src/
  - docker exec -it poly_backend vendor/bin/phpunit --coverage-clover=coverage.clover

after_script:
  - wget https://scrutinizer-ci.com/ocular.phar
  - php ocular.phar code-coverage:upload --format=php-clover coverage.clover
